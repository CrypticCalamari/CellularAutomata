<script>
var CA = CA || {};

CA.BoardView = (function() {
    return {
        inspectCell: function( event ) {
            
        },
        paintCellState: function( event ) {
            var view = document.getElementById('boardCanvas');
            var x = Math.floor( (event.pageX - view.offsetLeft) / CA.cellSize );
            var y = Math.floor( (event.pageY - view.offsetTop) / CA.cellSize );

            CA.board.setCellState( x, y, CA.stateBrush );
            CA.BoardView.redrawCell( view, x, y, CA.states[ CA.stateBrush ].color );
        },
        paintCellLineState: function( event ) {
            if (CA.mouseDown) {
                var view = document.getElementById('boardCanvas');
                var x = Math.floor( (event.pageX - view.offsetLeft) / CA.cellSize );
                var y = Math.floor( (event.pageY - view.offsetTop) / CA.cellSize );

                CA.board.setCellState( x, y, CA.stateBrush );
                CA.BoardView.redrawCell( view, x, y, CA.states[ CA.stateBrush ].color );
            }
        },
        paintCellRegion: function( event ) {
            var view = document.getElementById('boardCanvas');
            var x = Math.floor( (event.pageX - view.offsetLeft) / CA.cellSize );
            var y = Math.floor( (event.pageY - view.offsetTop) / CA.cellSize );

            CA.board.setCellRegion( x, y, CA.regionBrush );
        },
        zoomIn: function( event ) {
            
        },
        zoomOut: function( event ) {
            
        },
        redrawCell: function( view, x, y, color ) {
            var cellSize = CA.cellSize;
            var context = view.getContext('2d');

            context.fillStyle = color;
            context.fillRect(x * cellSize, y * cellSize, cellSize, cellSize);
        },
        redrawBoard: function( view ) {
            var board = CA.board;
            var width = CA.board.width;
            var height = CA.board.height;
            var cellSize = CA.cellSize;
            var view = document.getElementById('boardCanvas');
            var context = view.getContext('2d');

            for (var x = 0; x < width; x++) {
                for (var y = 0; y < height; y++) {
                    context.fillStyle = CA.states[ board.getCellState( x, y ) ].color;
                    context.fillRect(x * cellSize, y * cellSize, cellSize, cellSize);
                }
            }

            // Fix this later to use double buffering once I move away from Google Apps Scrips and the bullshit that is Caja
        },
        mouseDown: function( event ) {
            CA.mouseDown = true;
        },
        mouseUp: function( event ) {
            CA.mouseDown = false;
        },
        init: function() {
            var stateBrushSelect = document.getElementById('stateBrushSelection');

            for (var i = 0; i < CA.states.length; i++) {
                var stateNode = document.createElement('div');

                stateNode.style.backgroundColor = CA.states[i].color;
                stateNode.className = 'stateBrushSelectNode';
                stateNode['data-name'] = CA.states[i].name;
                stateNode['data-color'] = CA.states[i].color;
                stateNode['data-value'] = i;

                stateBrushSelect.appendChild( stateNode );
            }
        }
    };
})();

CA.BoardClickHandler = (function() {
    var strategy = null;

    return {
        setStrategy: function( s ) {
            strategy = s;
        },
        click: function( event ) {
            strategy( event );
        }
    };
})();

CA.setupEventListeners = function() {
    var view = document.getElementById('boardCanvas');
    CA.BoardClickHandler.setStrategy( CA.BoardView.paintCellState );
    view.addEventListener('click', CA.BoardClickHandler.click);
    view.addEventListener('mousedown', CA.BoardView.mouseDown);
    view.addEventListener('mouseup', CA.BoardView.mouseUp);
    view.addEventListener('mousemove', CA.BoardView.paintCellLineState);
}

CA.BoardView.init();
CA.setupEventListeners();

console.log('BoardView.html processed');
</script>
